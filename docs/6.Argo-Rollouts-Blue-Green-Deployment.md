# ğŸŒ€ Argo Rollouts Blue-Green Deployment

## ğŸ“˜ Overview
This example demonstrates a **Blue-Green deployment** using **Argo Rollouts** with the demo image `argoproj/rollouts-demo`.  
It uses **two services** (active and preview) and **two ingress resources** (one for live traffic and one for testing).

---

## ğŸš€ Rollout Definition

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollout-bluegreen
  namespace: default
spec:
  replicas: 2
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      app: rollout-bluegreen
  template:
    metadata:
      labels:
        app: rollout-bluegreen
    spec:
      containers:
      - name: rollouts-demo
        image: argoproj/rollouts-demo:blue
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      autoPromotionEnabled: false
```

Apply it:
```bash
kubectl apply -f rollout.yaml
kubectl argo rollouts list rollouts -n default
```
Expected Output: 
```
NAME               STRATEGY   STATUS        STEP  SET-WEIGHT  READY  DESIRED  UP-TO-DATE  AVAILABLE
rollout-bluegreen  BlueGreen  Healthy       -     -           2/2    2        2           2
```

---

## ğŸŒ Service Definitions

### Active Service (Production)
```yaml
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
  namespace: default
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: rollout-bluegreen
```

### Preview Service (Testing)
```yaml
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
  namespace: default
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: rollout-bluegreen
```

Apply:
```bash
kubectl apply -f services.yaml
kubectl get svc -n default
```
Expected Output:
```
NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
kubernetes                  ClusterIP   10.96.0.1        <none>        443/TCP   129d
rollout-bluegreen-active    ClusterIP   10.101.9.52      <none>        80/TCP    35h
rollout-bluegreen-preview   ClusterIP   10.101.238.220   <none>        80/TCP    35h
```

---

## ğŸŒ Ingress Resources

### Ingress for Live Traffic
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rollout-bluegreen-live-ingress
  namespace: default
spec:
  ingressClassName: nginx
  rules:
  - host: blue.apsis.localnet
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: rollout-bluegreen-active
            port:
              number: 80
```

### Ingress for Preview (Testing)
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rollout-bluegreen-preview-ingress
  namespace: default
spec:
  ingressClassName: nginx
  rules:
  - host: green.apsis.localnet
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: rollout-bluegreen-preview
            port:
              number: 80
```

Apply:
```bash
kubectl apply -f ingress.yaml
kubectl get ingress -n default
```
Expected Output: 
```
NAME                                CLASS   HOSTS                  ADDRESS          PORTS   AGE
rollout-bluegreen-live-ingress      nginx   blue.apsis.localnet    192.168.20.162   80      35h
rollout-bluegreen-preview-ingress   nginx   green.apsis.localnet   192.168.20.162   80      35h
```

On UI (Both http://blue.apsis.localnet and http://green.apsis.localnet have the same blue interface):
<img width="1633" height="679" alt="image" src="https://github.com/user-attachments/assets/6a336123-38a1-441b-9a28-b9fee1766e52" />

---

## ğŸ”„ Deploying Green Version

Update the rollout to use the green image:
```bash
kubectl argo rollouts set image rollout-bluegreen rollouts-demo=argoproj/rollouts-demo:green
```

Watch progress:
```bash
kubectl argo rollouts get rollout rollout-bluegreen --watch
```
Expected Output:
```
Name:            rollout-bluegreen
Namespace:       default
Status:          à¥¥ Paused
Message:         BlueGreenPause
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:blue (stable, active)
                 argoproj/rollouts-demo:green (preview)
Replicas:
  Desired:       2
  Current:       4
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS     AGE   INFO
âŸ³ rollout-bluegreen                            Rollout     à¥¥ Paused   36m
â”œâ”€â”€# revision:2
â”‚  â””â”€â”€â§‰ rollout-bluegreen-75695867f            ReplicaSet  âœ” Healthy  101s  preview
â”‚     â”œâ”€â”€â–¡ rollout-bluegreen-75695867f-pk5d8   Pod         âœ” Running  101s  ready:1/1
â”‚     â””â”€â”€â–¡ rollout-bluegreen-75695867f-q285b   Pod         âœ” Running  101s  ready:1/1
â””â”€â”€# revision:1
   â””â”€â”€â§‰ rollout-bluegreen-5ffd47b8d4           ReplicaSet  âœ” Healthy  14m   stable,active
      â”œâ”€â”€â–¡ rollout-bluegreen-5ffd47b8d4-26xnd  Pod         âœ” Running  14m   ready:1/1
      â””â”€â”€â–¡ rollout-bluegreen-5ffd47b8d4-6kj57  Pod         âœ” Running  14m   ready:1/1
```
On UI (For http://blue.apsis.localnet):
<img width="1630" height="681" alt="image" src="https://github.com/user-attachments/assets/8cd414dc-4d23-48c0-b112-7bbd57e2347c" />

On UI (For http://green.apsis.localnet):
<img width="1638" height="680" alt="image" src="https://github.com/user-attachments/assets/5787b4fc-3411-47b0-981c-959285a898b5" />


Promote once verified:
```bash
kubectl argo rollouts promote rollout-bluegreen
kubectl argo rollouts get rollout rollout-bluegreen --watch
```
Expected Output: 
```
Name:            rollout-bluegreen
Namespace:       default
Status:          âœ” Healthy
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:green (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS         AGE    INFO
âŸ³ rollout-bluegreen                            Rollout     âœ” Healthy      8m41s
â”œâ”€â”€# revision:2
â”‚  â””â”€â”€â§‰ rollout-bluegreen-75695867f            ReplicaSet  âœ” Healthy      2m53s  stable,active
â”‚     â”œâ”€â”€â–¡ rollout-bluegreen-75695867f-5tn84   Pod         âœ” Running      2m53s  ready:1/1
â”‚     â””â”€â”€â–¡ rollout-bluegreen-75695867f-m9g4f   Pod         âœ” Running      2m53s  ready:1/1
â””â”€â”€# revision:1
   â””â”€â”€â§‰ rollout-bluegreen-5ffd47b8d4           ReplicaSet  â€¢ ScaledDown   8m41s
      â”œâ”€â”€â–¡ rollout-bluegreen-5ffd47b8d4-25g58  Pod         â—Œ Terminating  8m41s  ready:1/1
      â””â”€â”€â–¡ rollout-bluegreen-5ffd47b8d4-ptdbd  Pod         â—Œ Terminating  8m41s  ready:1/1
```
```bash
kubectl argo rollouts get rollout rollout-bluegreen
```
Expected Output: 
```
Name:            rollout-bluegreen
Namespace:       default
Status:          âœ” Healthy
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:green (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                          KIND        STATUS        AGE    INFO
âŸ³ rollout-bluegreen                           Rollout     âœ” Healthy     8m51s
â”œâ”€â”€# revision:2
â”‚  â””â”€â”€â§‰ rollout-bluegreen-75695867f           ReplicaSet  âœ” Healthy     3m3s   stable,active
â”‚     â”œâ”€â”€â–¡ rollout-bluegreen-75695867f-5tn84  Pod         âœ” Running     3m3s   ready:1/1
â”‚     â””â”€â”€â–¡ rollout-bluegreen-75695867f-m9g4f  Pod         âœ” Running     3m3s   ready:1/1
â””â”€â”€# revision:1
   â””â”€â”€â§‰ rollout-bluegreen-5ffd47b8d4          ReplicaSet  â€¢ ScaledDown  8m51s
```
On UI (Both http://blue.apsis.localnet and http://green.apsis.localnet have the same green interface):
<img width="1628" height="681" alt="image" src="https://github.com/user-attachments/assets/564c0281-0ea6-4e93-b9e8-d5a4064c5756" />

Rollback if needed:
```bash
kubectl argo rollouts get rollout rollout-bluegreen -n default
```
Expected Output:
```
Name:            rollout-bluegreen
Namespace:       default
Status:          âœ” Healthy
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:green (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                          KIND        STATUS        AGE    INFO
âŸ³ rollout-bluegreen                           Rollout     âœ” Healthy     8m14s
â”œâ”€â”€# revision:2
â”‚  â””â”€â”€â§‰ rollout-bluegreen-75695867f           ReplicaSet  âœ” Healthy     6m51s  stable,active
â”‚     â”œâ”€â”€â–¡ rollout-bluegreen-75695867f-d9fm6  Pod         âœ” Running     6m51s  ready:1/1
â”‚     â””â”€â”€â–¡ rollout-bluegreen-75695867f-nb5ck  Pod         âœ” Running     6m51s  ready:1/1
â””â”€â”€# revision:1
   â””â”€â”€â§‰ rollout-bluegreen-5ffd47b8d4          ReplicaSet  â€¢ ScaledDown  8m14s
```
Check the image and revision number used for the stable and preview version (Not recommended with revision number on CLI, rather updated manifest image).
```
kubectl argo rollouts undo rollout-bluegreen --to-revision=1 -n default
```
Rollback by changing image and promote the rollout.
```
kubectl argo rollouts set image rollout-bluegreen rollouts-demo=argoproj/rollouts-demo:blue
kubectl argo rollouts promote rollout-bluegreen -n default
kubectl argo rollouts get rollout rollout-bluegreen --watch -n default
```
Expected Output: 
```
Name:            rollout-bluegreen
Namespace:       default
Status:          âœ” Healthy
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:blue (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS        AGE   INFO
âŸ³ rollout-bluegreen                            Rollout     âœ” Healthy     14m
â”œâ”€â”€# revision:3
â”‚  â””â”€â”€â§‰ rollout-bluegreen-5ffd47b8d4           ReplicaSet  âœ” Healthy     14m   stable,active
â”‚     â”œâ”€â”€â–¡ rollout-bluegreen-5ffd47b8d4-26ngz  Pod         âœ” Running     109s  ready:1/1
â”‚     â””â”€â”€â–¡ rollout-bluegreen-5ffd47b8d4-dljqr  Pod         âœ” Running     109s  ready:1/1
â””â”€â”€# revision:2
   â””â”€â”€â§‰ rollout-bluegreen-75695867f            ReplicaSet  â€¢ ScaledDown  13m
```

---

## ğŸ“Š Verification & Monitoring

Check rollout status:
```bash
kubectl argo rollouts get rollout rollout-bluegreen
```

---

## ğŸ” Traffic Flow Diagram

```
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚        Ingress              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                           â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ rollout-bluegreen-active   â”‚ â”‚ rollout-bluegreen-preview  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Blue Pods  â”‚                â”‚ Green Pods â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Best Practices
- Always define **readiness probes** to prevent traffic from going to unhealthy pods.
- Keep **autoPromotionEnabled: false** for manual promotion in production.
- Expose **preview ingress** only to internal QA/testing environments.
- Use **revisionHistoryLimit** to limit stored versions and save resources.

---

## ğŸ§© Summary

| Resource | Purpose |
|-----------|----------|
| Rollout | Controls Blue-Green deployment logic |
| rollout-bluegreen-active | Production service |
| rollout-bluegreen-preview | Test service |
| rollout-bluegreen-live-ingress | User-facing ingress |
| rollout-bluegreen-preview-ingress | QA ingress |
| argoproj/rollouts-demo:blue | Blue image |
| argoproj/rollouts-demo:green | Green image |
