# 🌀 Argo Rollouts Blue-Green Deployment

## 📘 Overview
This example demonstrates a **Blue-Green deployment** using **Argo Rollouts** with the demo image `argoproj/rollouts-demo`.  
It uses **two services** (active and preview) and **two ingress resources** (one for live traffic and one for testing).

---

## 🚀 Rollout Definition

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollout-bluegreen
  namespace: default
spec:
  replicas: 2
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      app: rollout-bluegreen
  template:
    metadata:
      labels:
        app: rollout-bluegreen
    spec:
      containers:
      - name: rollouts-demo
        image: argoproj/rollouts-demo:blue
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      autoPromotionEnabled: false
```

Apply it:
```bash
kubectl apply -f rollout.yaml
```

---

## 🌐 Service Definitions

### Active Service (Production)
```yaml
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
  namespace: default
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: rollout-bluegreen
```

### Preview Service (Testing)
```yaml
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
  namespace: default
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: rollout-bluegreen
```

Apply:
```bash
kubectl apply -f services.yaml
```

---

## 🌍 Ingress Resources

### Ingress for Live Traffic
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rollout-bluegreen-live-ingress
  namespace: default
spec:
  ingressClassName: nginx
  rules:
  - host: blue.apsis.localnet
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: rollout-bluegreen-active
            port:
              number: 80
```

### Ingress for Preview (Testing)
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rollout-bluegreen-preview-ingress
  namespace: default
spec:
  ingressClassName: nginx
  rules:
  - host: green.apsis.localnet
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: rollout-bluegreen-preview
            port:
              number: 80
```

Apply:
```bash
kubectl apply -f ingress.yaml
```
On UI (Both http://blue.apsis.localnet and http://green.apsis.localnet have the same blue interface):
![alt text](image-2.png)

---

## 🔄 Deploying Green Version

Update the rollout to use the green image:
```bash
kubectl argo rollouts set image rollout-bluegreen rollouts-demo=argoproj/rollouts-demo:green
```

Watch progress:
```bash
kubectl argo rollouts get rollout rollout-bluegreen --watch
```
Expected Output:
```
Name:            rollout-bluegreen
Namespace:       default
Status:          ॥ Paused
Message:         BlueGreenPause
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:blue (stable, active)
                 argoproj/rollouts-demo:green (preview)
Replicas:
  Desired:       2
  Current:       4
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS     AGE   INFO
⟳ rollout-bluegreen                            Rollout     ॥ Paused   36m
├──# revision:2
│  └──⧉ rollout-bluegreen-75695867f            ReplicaSet  ✔ Healthy  101s  preview
│     ├──□ rollout-bluegreen-75695867f-pk5d8   Pod         ✔ Running  101s  ready:1/1
│     └──□ rollout-bluegreen-75695867f-q285b   Pod         ✔ Running  101s  ready:1/1
└──# revision:1
   └──⧉ rollout-bluegreen-5ffd47b8d4           ReplicaSet  ✔ Healthy  14m   stable,active
      ├──□ rollout-bluegreen-5ffd47b8d4-26xnd  Pod         ✔ Running  14m   ready:1/1
      └──□ rollout-bluegreen-5ffd47b8d4-6kj57  Pod         ✔ Running  14m   ready:1/1
```
On UI (For http://blue.apsis.localnet):
![alt text](image-3.png)

On UI (For http://green.apsis.localnet):
![alt text](image-4.png)

Promote once verified:
```bash
kubectl argo rollouts promote rollout-bluegreen
kubectl argo rollouts get rollout rollout-bluegreen --watch
```
Expected Output: 
```
Name:            rollout-bluegreen
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:green (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS         AGE    INFO
⟳ rollout-bluegreen                            Rollout     ✔ Healthy      8m41s
├──# revision:2
│  └──⧉ rollout-bluegreen-75695867f            ReplicaSet  ✔ Healthy      2m53s  stable,active
│     ├──□ rollout-bluegreen-75695867f-5tn84   Pod         ✔ Running      2m53s  ready:1/1
│     └──□ rollout-bluegreen-75695867f-m9g4f   Pod         ✔ Running      2m53s  ready:1/1
└──# revision:1
   └──⧉ rollout-bluegreen-5ffd47b8d4           ReplicaSet  • ScaledDown   8m41s
      ├──□ rollout-bluegreen-5ffd47b8d4-25g58  Pod         ◌ Terminating  8m41s  ready:1/1
      └──□ rollout-bluegreen-5ffd47b8d4-ptdbd  Pod         ◌ Terminating  8m41s  ready:1/1
```
```bash
kubectl argo rollouts get rollout rollout-bluegreen
```
Expected Output: 
```
Name:            rollout-bluegreen
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:green (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                          KIND        STATUS        AGE    INFO
⟳ rollout-bluegreen                           Rollout     ✔ Healthy     8m51s
├──# revision:2
│  └──⧉ rollout-bluegreen-75695867f           ReplicaSet  ✔ Healthy     3m3s   stable,active
│     ├──□ rollout-bluegreen-75695867f-5tn84  Pod         ✔ Running     3m3s   ready:1/1
│     └──□ rollout-bluegreen-75695867f-m9g4f  Pod         ✔ Running     3m3s   ready:1/1
└──# revision:1
   └──⧉ rollout-bluegreen-5ffd47b8d4          ReplicaSet  • ScaledDown  8m51s
```
On UI (Both http://blue.apsis.localnet and http://green.apsis.localnet have the same green interface):
![alt text](image-5.png)

Rollback if needed:
```bash
kubectl argo rollouts undo rollout-bluegreen
```

---

## 📊 Verification & Monitoring

Check rollout status:
```bash
kubectl argo rollouts get rollout rollout-bluegreen
```

Open dashboard:
```bash
kubectl argo rollouts dashboard
```

---

## 🔍 Traffic Flow Diagram

```
            ┌─────────────────────────────┐
            │        Ingress              │
            └────────────┬────────────────┘
                         │
           ┌─────────────┴─────────────┐
           │                           │
 ┌────────────────────────────┐ ┌────────────────────────────┐
 │ rollout-bluegreen-active   │ │ rollout-bluegreen-preview  │
 └────────┬───────────────────┘ └────────┬───────────────────┘
          │                             │
    ┌────────────┐                ┌────────────┐
    │ Blue Pods  │                │ Green Pods │
    └────────────┘                └────────────┘
```

---

## ✅ Best Practices
- Always define **readiness probes** to prevent traffic from going to unhealthy pods.
- Keep **autoPromotionEnabled: false** for manual promotion in production.
- Expose **preview ingress** only to internal QA/testing environments.
- Use **revisionHistoryLimit** to limit stored versions and save resources.

---

## 🧩 Summary

| Resource | Purpose |
|-----------|----------|
| Rollout | Controls Blue-Green deployment logic |
| rollout-bluegreen-active | Production service |
| rollout-bluegreen-preview | Test service |
| rollout-bluegreen-live-ingress | User-facing ingress |
| rollout-bluegreen-preview-ingress | QA ingress |
| argoproj/rollouts-demo:blue | Blue image |
| argoproj/rollouts-demo:green | Green image |
