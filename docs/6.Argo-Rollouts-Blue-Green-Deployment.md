# 🌀 Argo Rollouts Blue-Green Deployment

## 📘 Overview
This example demonstrates a **Blue-Green deployment** using **Argo Rollouts** with the demo image `argoproj/rollouts-demo`.  
It uses **two services** (active and preview) and **two ingress resources** (one for live traffic and one for testing).

---

## 🚀 Rollout Definition

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollout-bluegreen
  namespace: default
spec:
  replicas: 2
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      app: rollout-bluegreen
  template:
    metadata:
      labels:
        app: rollout-bluegreen
    spec:
      containers:
      - name: rollouts-demo
        image: argoproj/rollouts-demo:blue
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
  strategy:
    blueGreen: 
      activeService: rollout-bluegreen-active
      previewService: rollout-bluegreen-preview
      autoPromotionEnabled: false
```

Apply it:
```bash
kubectl apply -f rollout.yaml
kubectl argo rollouts list rollouts -n default
```
Expected Output: 
```
NAME               STRATEGY   STATUS        STEP  SET-WEIGHT  READY  DESIRED  UP-TO-DATE  AVAILABLE
rollout-bluegreen  BlueGreen  Healthy       -     -           2/2    2        2           2
```

---

## 🌐 Service Definitions

### Active Service (Production)
```yaml
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-active
  namespace: default
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: rollout-bluegreen
```

### Preview Service (Testing)
```yaml
apiVersion: v1
kind: Service
metadata:
  name: rollout-bluegreen-preview
  namespace: default
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: rollout-bluegreen
```

Apply:
```bash
kubectl apply -f services.yaml
kubectl get svc -n default
```
Expected Output:
```
NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
kubernetes                  ClusterIP   10.96.0.1        <none>        443/TCP   129d
rollout-bluegreen-active    ClusterIP   10.101.9.52      <none>        80/TCP    35h
rollout-bluegreen-preview   ClusterIP   10.101.238.220   <none>        80/TCP    35h
```

---

## 🌍 Ingress Resources

### Ingress for Live Traffic
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rollout-bluegreen-live-ingress
  namespace: default
spec:
  ingressClassName: nginx
  rules:
  - host: blue.apsis.localnet
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: rollout-bluegreen-active
            port:
              number: 80
```

### Ingress for Preview (Testing)
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rollout-bluegreen-preview-ingress
  namespace: default
spec:
  ingressClassName: nginx
  rules:
  - host: green.apsis.localnet
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: rollout-bluegreen-preview
            port:
              number: 80
```

Apply:
```bash
kubectl apply -f ingress.yaml
kubectl get ingress -n default
```
Expected Output: 
```
NAME                                CLASS   HOSTS                  ADDRESS          PORTS   AGE
rollout-bluegreen-live-ingress      nginx   blue.apsis.localnet    192.168.20.162   80      35h
rollout-bluegreen-preview-ingress   nginx   green.apsis.localnet   192.168.20.162   80      35h
```

On UI (Both http://blue.apsis.localnet and http://green.apsis.localnet have the same blue interface):
<img width="1633" height="679" alt="image" src="https://github.com/user-attachments/assets/6a336123-38a1-441b-9a28-b9fee1766e52" />

---

## 🔄 Deploying Green Version

Update the rollout to use the green image:
```bash
kubectl argo rollouts set image rollout-bluegreen rollouts-demo=argoproj/rollouts-demo:green
```

Watch progress:
```bash
kubectl argo rollouts get rollout rollout-bluegreen --watch
```
Expected Output:
```
Name:            rollout-bluegreen
Namespace:       default
Status:          ॥ Paused
Message:         BlueGreenPause
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:blue (stable, active)
                 argoproj/rollouts-demo:green (preview)
Replicas:
  Desired:       2
  Current:       4
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS     AGE   INFO
⟳ rollout-bluegreen                            Rollout     ॥ Paused   36m
├──# revision:2
│  └──⧉ rollout-bluegreen-75695867f            ReplicaSet  ✔ Healthy  101s  preview
│     ├──□ rollout-bluegreen-75695867f-pk5d8   Pod         ✔ Running  101s  ready:1/1
│     └──□ rollout-bluegreen-75695867f-q285b   Pod         ✔ Running  101s  ready:1/1
└──# revision:1
   └──⧉ rollout-bluegreen-5ffd47b8d4           ReplicaSet  ✔ Healthy  14m   stable,active
      ├──□ rollout-bluegreen-5ffd47b8d4-26xnd  Pod         ✔ Running  14m   ready:1/1
      └──□ rollout-bluegreen-5ffd47b8d4-6kj57  Pod         ✔ Running  14m   ready:1/1
```
On UI (For http://blue.apsis.localnet):
<img width="1630" height="681" alt="image" src="https://github.com/user-attachments/assets/8cd414dc-4d23-48c0-b112-7bbd57e2347c" />

On UI (For http://green.apsis.localnet):
<img width="1638" height="680" alt="image" src="https://github.com/user-attachments/assets/5787b4fc-3411-47b0-981c-959285a898b5" />


Promote once verified:
```bash
kubectl argo rollouts promote rollout-bluegreen
kubectl argo rollouts get rollout rollout-bluegreen --watch
```
Expected Output: 
```
Name:            rollout-bluegreen
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:green (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS         AGE    INFO
⟳ rollout-bluegreen                            Rollout     ✔ Healthy      8m41s
├──# revision:2
│  └──⧉ rollout-bluegreen-75695867f            ReplicaSet  ✔ Healthy      2m53s  stable,active
│     ├──□ rollout-bluegreen-75695867f-5tn84   Pod         ✔ Running      2m53s  ready:1/1
│     └──□ rollout-bluegreen-75695867f-m9g4f   Pod         ✔ Running      2m53s  ready:1/1
└──# revision:1
   └──⧉ rollout-bluegreen-5ffd47b8d4           ReplicaSet  • ScaledDown   8m41s
      ├──□ rollout-bluegreen-5ffd47b8d4-25g58  Pod         ◌ Terminating  8m41s  ready:1/1
      └──□ rollout-bluegreen-5ffd47b8d4-ptdbd  Pod         ◌ Terminating  8m41s  ready:1/1
```
```bash
kubectl argo rollouts get rollout rollout-bluegreen
```
Expected Output: 
```
Name:            rollout-bluegreen
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:green (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                          KIND        STATUS        AGE    INFO
⟳ rollout-bluegreen                           Rollout     ✔ Healthy     8m51s
├──# revision:2
│  └──⧉ rollout-bluegreen-75695867f           ReplicaSet  ✔ Healthy     3m3s   stable,active
│     ├──□ rollout-bluegreen-75695867f-5tn84  Pod         ✔ Running     3m3s   ready:1/1
│     └──□ rollout-bluegreen-75695867f-m9g4f  Pod         ✔ Running     3m3s   ready:1/1
└──# revision:1
   └──⧉ rollout-bluegreen-5ffd47b8d4          ReplicaSet  • ScaledDown  8m51s
```
On UI (Both http://blue.apsis.localnet and http://green.apsis.localnet have the same green interface):
<img width="1628" height="681" alt="image" src="https://github.com/user-attachments/assets/564c0281-0ea6-4e93-b9e8-d5a4064c5756" />

Rollback if needed:
```bash
kubectl argo rollouts get rollout rollout-bluegreen -n default
```
Expected Output:
```
Name:            rollout-bluegreen
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:green (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                          KIND        STATUS        AGE    INFO
⟳ rollout-bluegreen                           Rollout     ✔ Healthy     8m14s
├──# revision:2
│  └──⧉ rollout-bluegreen-75695867f           ReplicaSet  ✔ Healthy     6m51s  stable,active
│     ├──□ rollout-bluegreen-75695867f-d9fm6  Pod         ✔ Running     6m51s  ready:1/1
│     └──□ rollout-bluegreen-75695867f-nb5ck  Pod         ✔ Running     6m51s  ready:1/1
└──# revision:1
   └──⧉ rollout-bluegreen-5ffd47b8d4          ReplicaSet  • ScaledDown  8m14s
```
Check the image and revision number used for the stable and preview version (Not recommended with revision number on CLI, rather updated manifest image).
```
kubectl argo rollouts undo rollout-bluegreen --to-revision=1 -n default
```
Rollback by changing image and promote the rollout.
```
kubectl argo rollouts set image rollout-bluegreen rollouts-demo=argoproj/rollouts-demo:blue
kubectl argo rollouts promote rollout-bluegreen -n default
kubectl argo rollouts get rollout rollout-bluegreen --watch -n default
```
Expected Output: 
```
Name:            rollout-bluegreen
Namespace:       default
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          argoproj/rollouts-demo:blue (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                           KIND        STATUS        AGE   INFO
⟳ rollout-bluegreen                            Rollout     ✔ Healthy     14m
├──# revision:3
│  └──⧉ rollout-bluegreen-5ffd47b8d4           ReplicaSet  ✔ Healthy     14m   stable,active
│     ├──□ rollout-bluegreen-5ffd47b8d4-26ngz  Pod         ✔ Running     109s  ready:1/1
│     └──□ rollout-bluegreen-5ffd47b8d4-dljqr  Pod         ✔ Running     109s  ready:1/1
└──# revision:2
   └──⧉ rollout-bluegreen-75695867f            ReplicaSet  • ScaledDown  13m
```

---

## 📊 Verification & Monitoring

Check rollout status:
```bash
kubectl argo rollouts get rollout rollout-bluegreen
```

---

## 🔍 Traffic Flow Diagram

```
            ┌─────────────────────────────┐
            │        Ingress              │
            └────────────┬────────────────┘
                         │
           ┌─────────────┴─────────────┐
           │                           │
 ┌────────────────────────────┐ ┌────────────────────────────┐
 │ rollout-bluegreen-active   │ │ rollout-bluegreen-preview  │
 └────────┬───────────────────┘ └────────┬───────────────────┘
          │                             │
    ┌────────────┐                ┌────────────┐
    │ Blue Pods  │                │ Green Pods │
    └────────────┘                └────────────┘
```

---

## ✅ Best Practices
- Always define **readiness probes** to prevent traffic from going to unhealthy pods.
- Keep **autoPromotionEnabled: false** for manual promotion in production.
- Expose **preview ingress** only to internal QA/testing environments.
- Use **revisionHistoryLimit** to limit stored versions and save resources.

---

## 🧩 Summary

| Resource | Purpose |
|-----------|----------|
| Rollout | Controls Blue-Green deployment logic |
| rollout-bluegreen-active | Production service |
| rollout-bluegreen-preview | Test service |
| rollout-bluegreen-live-ingress | User-facing ingress |
| rollout-bluegreen-preview-ingress | QA ingress |
| argoproj/rollouts-demo:blue | Blue image |
| argoproj/rollouts-demo:green | Green image |
